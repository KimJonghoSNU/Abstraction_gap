# Round3 context refactor plan (2026-01-21)

## 현재 버전 (as-is)
- rewrite context는 local/global 분리 흐름을 따름.
    - 기본: leaf_descs는 local leaf top-K (anchor/local 기반)에서 추출.
    - --round3_anchor_local_rank v2: anchor top-K 순서에서 branch를 최고점 leaf로 치환한 결과를 context로 사용.
    - branch_descs는 ranked_branches (density + branch_score) 기준 top-K를 사용함.
- 즉, branch_descs는 **flat retrieval 순서와 무관**하게 density 기반 ranking으로 구성됨.
- 평가 지표는 global 중심으로 보고 있으며, RRF는 제거됨.

## 변경안 (to-be)
- rewrite context는 local/global 분리 없이 **flat retrieval 결과(anchor hits)**만 사용.
    - leaf_descs: flat retrieval 결과 중 **top-K leaf**만 추출 (retrieval score 순서).
    - branch_descs: flat retrieval 결과 중 **top-K branch**만 추출 (retrieval score 순서).
- --round3_anchor_local_rank == "v2"인 경우:
    - flat retrieval 결과의 **순서를 유지**하되,
      branch hit은 해당 branch 하위 leaf 중 최고점 leaf로 치환해서 leaf_descs를 구성.
    - branch_descs는 위와 동일하게 flat retrieval branch top-K를 별도 유지.

## 비판적 코멘트
- 장점: rewrite context가 retriever의 실제 관측(top-K)과 직접 정렬됨.
- 위험: density/active-branch 신호가 사라져 locality 유지 효과가 약해질 수 있음.
- branch_descs가 flat retrieval 기반일 때, 너무 추상적이거나 노이즈가 많은 branch가 컨텍스트를 오염시킬 수 있음.
    - 특히 explore/exploit router에 영향이 커질 수 있으니, K 값을 보수적으로 유지하는 게 안전.
