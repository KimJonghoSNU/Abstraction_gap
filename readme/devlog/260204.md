# 2026-02-04 업데이트: Rewrite에 Retrieval History 주입

## 배경
- 목표: query rewrite 시점에 "이전 iteration에서 무엇을 검색했는지"를 함께 보여줘서, episodic memory 스타일의 제어를 실험.
- 제약: document content는 넣지 않고, doc ID만 사용.

## 구현 내용
- `src/history_prompts.py` 추가
    - `build_retrieval_history_block(...)`
        - 모든 이전 iter를 표 형태로 구성
        - 컬럼: `Iter`, `Action`, `Query Used`, `Retrieved Doc IDs (Top-K)`
    - `prepend_history_to_prompt(...)`
        - history block을 rewrite/router prompt 앞에 prepend
- `src/run_round3_1.py` 수정
    - rewrite/router prompt 생성 시 history block 주입
    - iter 기록(`iter_records`)에 아래 항목 추가
        - `query_action`, `query_actions`, `query_possible_docs`
        - `anchor_eval_paths`
    - 의도: 각 iter에서 실제 retrieval에 사용된 query/action 상태를 history에 정확히 반영
- `src/hyperparams.py` 수정
    - 신규 인자:
        - `--round3_rewrite_use_history`
        - `--round3_rewrite_history_topk` (default: 10)
    - 경로 길이 축소:
        - `round3_router_prompt_name`이 없으면 `round3_router_*` naming 제외
        - `round3_rewrite_use_history=False`면 `round3_rewrite_history_topk` naming 제외
- 실행 스크립트 추가
    - `src/bash/round3/run_round3_anchor_local_rank_history.sh`
    - 기본적으로 history 옵션을 켜고 실행하도록 설정

## 사용법
- 기존 run에 history를 켜려면:
    - `--round3_rewrite_use_history`
    - `--round3_rewrite_history_topk 10`
- 새 스크립트 사용:
    - `bash src/bash/round3/run_round3_anchor_local_rank_history.sh`

## 현재 해석 포인트
- history는 "이전 iter 전부"를 포함(현재 실험 설정 `num_iters=10` 기준, 최대 10개 row).
- action-aware rewrite(explore/exploit 포함)에서도 어떤 action으로 retrieval했는지 history에 함께 기록됨.

## 2026-02-04 추가: `round3_anchor_local_rank` v5/v6 정리
- 공통
    - 평가/컨텍스트의 anchor 순서는 branch 치환(v2) 기반이 아니라 `anchor_local_rank=none`과 동일한 leaf-only anchor 순서를 seed로 사용.
    - seed 10 + expanded 10 = candidate 20을 만든 뒤, LLM rerank로 최종 top-10을 선택.
- `v5`
    - candidate 20을 leaf-only anchor 상위 leaf들로 구성.
    - 그 20개를 LLM이 relevance 기준으로 재정렬/필터링하고 top-10을 확정.
- `v6`
    - 먼저 leaf-only anchor top-10(seed)을 만든다.
    - extra 10은 query 점수가 아니라, 각 candidate leaf에 대해
      `max_{seed in top10} cosine(emb(candidate), emb(seed))` 로 점수화해 선별.
    - 추가 제약: seed의 `doc.id prefix`( `.txt`, trailing `_<숫자>` 제거)와 같은 prefix의 candidate는 제외.
    - 즉, v6는 "현재 top-10과 임베딩 공간에서 가까운 이웃"을 모아서 rerank하는 PRF-like 확장이다.

## 2026-02-04 추가: v6용 leaf-kNN precompute (속도 최적화)
- `scripts/precompute_leaf_knn_graph.py` 추가
    - leaf 문서별 top-K(기본 K=100) 유사 leaf와 cosine score를 오프라인 저장.
    - 출력: `trees/{dataset}/{subset}/leaf_knn_top{K}.npz`
    - 저장 키:
        - `leaf_registry_indices`
        - `neighbor_registry_indices`
        - `neighbor_scores`
- `src/run_round3_1.py` 업데이트
    - `--round3_v6_leaf_knn_path`를 주면 v6 extra 후보 생성 시 precomputed kNN을 우선 사용.
    - 부족분만 기존 dense 계산으로 보완해 동작 호환 유지.
