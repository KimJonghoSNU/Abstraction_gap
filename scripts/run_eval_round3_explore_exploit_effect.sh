#!/bin/bash

export CUDA_VISIBLE_DEVICES=2,3

set -euo pipefail

SUBSETS=(
    "biology"
    "earth_science"
    "economics"
    "psychology"
    "robotics"
)

RESULTS_ROOT="${RESULTS_ROOT:-results/BRIGHT}"
ORACLE_RUN_TAG="${ORACLE_RUN_TAG:-round3_action_oracle_ndcg_round3_action_v1}"
RAO_TAG="${RAO_TAG:-RAO=ndcg}"
OUT_DIR="results/analysis/explore_exploit_effect"
mkdir -p "${OUT_DIR}"

pick_single_or_fail() {
    local label="$1"
    local values="$2"
    local count
    count=$(printf "%s\n" "${values}" | sed '/^$/d' | wc -l)
    if [[ "${count}" -ne 1 ]]; then
        echo "[ERROR] ${label}: expected exactly 1 match, found ${count}" >&2
        printf "%s\n" "${values}" >&2
        exit 1
    fi
    printf "%s\n" "${values}" | sed '/^$/d'
}

for subset in "${SUBSETS[@]}"; do
    echo "[INFO] subset=${subset}"

    oracle_candidates=$(
        find "${RESULTS_ROOT}/${subset}" -type f -name "all_eval_sample_dicts.pkl" \
        | grep "S=${ORACLE_RUN_TAG}-" \
        | grep "RPN=round3_action_v1" \
        | grep "${RAO_TAG}" || true
    )
    oracle_pkl=$(pick_single_or_fail "oracle(${subset})" "${oracle_candidates}")

    out_json="${OUT_DIR}/${subset}_round3_action_oracle_action_effect.json"
    echo "[INFO] eval_pkl=${oracle_pkl}"
    echo "[INFO] out=${out_json}"

    python scripts/eval_round3_explore_exploit_effect.py \
        --eval_pkl_paths "${oracle_pkl}" \
        --eval_k 10 \
        --output_json "${out_json}"
done

echo "[DONE] Wrote reports to ${OUT_DIR}"
